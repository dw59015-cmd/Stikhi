name: Android CI (ZIP → patch → build)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Pick ZIP (prefer v1_2)
        id: pickzip
        run: |
          set -e
          if [ -f "Stikhi_v1_2.zip" ]; then
            echo "zip=Stikhi_v1_2.zip" >> $GITHUB_OUTPUT
          elif [ -f "Stikhi.zip" ]; then
            echo "zip=Stikhi.zip" >> $GITHUB_OUTPUT
          else
            echo "❌ ZIP not found"; exit 1
          fi
          echo "Using $(cat $GITHUB_OUTPUT)"

      - name: Unzip ZIP to workspace
        run: |
          rm -rf repo && mkdir repo
          unzip -q "${{ steps.pickzip.outputs.zip }}" -d repo
          echo "Top-level after unzip:"
          ls -la repo

      - name: Detect Gradle project root
        id: detect
        run: |
          set -e
          ROOT=$(dirname "$(find repo -maxdepth 2 -type f \( -name 'settings.gradle' -o -name 'settings.gradle.kts' \) | head -n1)")
          if [ -z "$ROOT" ]; then echo "❌ settings.gradle* not found"; exit 1; fi
          echo "root=$ROOT" >> $GITHUB_OUTPUT
          echo "Detected root: $ROOT"
          echo "Tree:"
          find "$ROOT" -maxdepth 2 -type f -printf '%P\n' | sort

      - name: Find Kotlin version (if declared)
        id: kver
        run: |
          ROOT='${{ steps.detect.outputs.root }}'
          KVER="$(grep -Po 'org.jetbrains.kotlin.android.*version\\s*\"\\K[0-9. ]+' "$ROOT"/build.gradle.kts 2>/dev/null || true)"
          if [ -z "$KVER" ]; then KVER="2.0.20"; fi
          echo "kver=$KVER" >> $GITHUB_OUTPUT
          echo "Kotlin version: $KVER"

      - name: Patch Gradle files (add Compose compiler plugin)
        run: |
          set -e
          ROOT='${{ steps.detect.outputs.root }}'
          KVER='${{ steps.kver.outputs.kver }}'

          add_plugin_kts_root() {
            FILE="$1"
            grep -q 'org.jetbrains.kotlin.plugin.compose' "$FILE" && return 0
            sed -i '0,/plugins *{/{s//plugins {\n    id("org.jetbrains.kotlin.plugin.compose") version "'"$KVER"'" apply false/}' "$FILE"
            echo "Patched: $FILE"
          }

          add_plugin_groovy_root() {
            FILE="$1"
            grep -q 'org.jetbrains.kotlin.plugin.compose' "$FILE" && return 0
            sed -i "0,/plugins *{/{s//plugins {\\n    id 'org.jetbrains.kotlin.plugin.compose' version '$KVER' apply false/}" "$FILE"
            echo "Patched: $FILE"
          }

          add_plugin_kts_app() {
            FILE="$1"
            grep -q 'org.jetbrains.kotlin.plugin.compose' "$FILE" && return 0
            sed -i '0,/plugins *{/{s//plugins {\n    id("org.jetbrains.kotlin.plugin.compose")/}' "$FILE"
            echo "Patched: $FILE"
          }

          add_plugin_groovy_app() {
            FILE="$1"
            grep -q 'org.jetbrains.kotlin.plugin.compose' "$FILE" && return 0
            sed -i "0,/plugins *{/{s//plugins {\\n    id 'org.jetbrains.kotlin.plugin.compose'/}" "$FILE"
            echo "Patched: $FILE"
          }

          # root build file
          if [ -f "$ROOT/build.gradle.kts" ]; then add_plugin_kts_root "$ROOT/build.gradle.kts"
          elif [ -f "$ROOT/build.gradle" ]; then add_plugin_groovy_root "$ROOT/build.gradle"
          else echo "⚠️ root build.gradle* not found"; fi

          # app module build file
          if [ -f "$ROOT/app/build.gradle.kts" ]; then add_plugin_kts_app "$ROOT/app/build.gradle.kts"
          elif [ -f "$ROOT/app/build.gradle" ]; then add_plugin_groovy_app "$ROOT/app/build.gradle"
          else echo "⚠️ app/build.gradle* not found"; fi

          echo "Show app build header:"
          head -n 40 "$ROOT/app/build.gradle.kts" 2>/dev/null || head -n 40 "$ROOT/app/build.gradle" || true

      - name: Set up Java 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      - name: Set up Android SDK
        uses: android-actions/setup-android@v3

      - name: Accept SDK licenses
        run: yes | sdkmanager --licenses

      - name: Build APK (release)
        working-directory: ${{ steps.detect.outputs.root }}
        run: |
          set -e
          if [ -f "./gradlew" ]; then
            chmod +x ./gradlew
            ./gradlew :app:assembleRelease --no-daemon
          else
            echo "Wrapper not found; using system gradle"
            gradle :app:assembleRelease --no-daemon
          fi

      - name: Upload APK artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: Stikhi-release-apk
          path: "${{ steps.detect.outputs.root }}/app/build/outputs/apk/release/*.apk"
