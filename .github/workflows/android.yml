name: Android CI (build from ZIP)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install unzip
        run: |
          sudo apt-get update -y
          sudo apt-get install -y unzip tree

      # Если есть архив, распакуем
      - name: Unzip Stikhi.zip (if present)
        run: |
          if [ -f Stikhi.zip ]; then
            rm -rf extracted
            unzip -o Stikhi.zip -d extracted
          fi
          echo "Root:"
          ls -la
          echo "Extracted (if any):"
          [ -d extracted ] && tree -L 2 extracted || true

      # Находим папку проекта, где лежит settings.gradle(.kts)
      - name: Detect project dir
        id: detect
        shell: bash
        run: |
          set -e
          # Кандидаты: корень или распакованный архив
          if [ -f settings.gradle.kts ] || [ -f settings.gradle ]; then
            DIR="."
          elif [ -d extracted ]; then
            # 1) если единственная папка внутри extracted — возьмём её
            TOP=$(find extracted -mindepth 1 -maxdepth 1 -type d | head -n1 || true)
            # 2) найдём settings.gradle глубже, если не угадали
            CAND=$(find extracted -type f -regex ".*/settings\.gradle\(\\.kts\)?" -printf "%h\n" | head -n1 || true)
            if [ -n "$CAND" ]; then
              DIR="$CAND"
            elif [ -n "$TOP" ]; then
              DIR="$TOP"
            else
              DIR="extracted"
            fi
          else
            # последний шанс — поиск по репо
            CAND=$(git ls-files | grep -E 'settings\.gradle(\.kts)?' | head -n1 || true)
            DIR=$(dirname "$CAND")
            [ -z "$DIR" ] && DIR="."
          fi
          echo "project_dir=$DIR" >> $GITHUB_OUTPUT
          echo "Using project_dir=$DIR"
          echo "Tree of project_dir:"
          tree -L 2 "$DIR" || true

      - name: Set up Java 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'

      - name: Set up Android SDK
        uses: android-actions/setup-android@v3

      - name: Install SDK packages
        run: |
          yes | sdkmanager --licenses
          sdkmanager "platform-tools" "platforms;android-34" "build-tools;34.0.0"

      # Если есть gradlew — используем его, иначе — Gradle action
      - name: Build with Gradle Wrapper (if present)
        if: hashFiles(format('{0}/gradlew', steps.detect.outputs.project_dir)) != ''
        working-directory: ${{ steps.detect.outputs.project_dir }}
        run: |
          chmod +x gradlew
          ./gradlew --no-daemon assembleDebug

      - name: Build with Gradle Action (fallback)
        if: hashFiles(format('{0}/gradlew', steps.detect.outputs.project_dir)) == ''
        uses: gradle/gradle-build-action@v3
        with:
          gradle-version: 8.9
          build-root-directory: ${{ steps.detect.outputs.project_dir }}
          arguments: assembleDebug

      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: Stikhi-debug-apk
          path: ${{ steps.detect.outputs.project_dir }}/app/build/outputs/apk/debug/app-debug.apk
