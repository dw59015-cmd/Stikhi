name: Android CI (from ZIP, robust)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install tools
        run: |
          sudo apt-get update -y
          sudo apt-get install -y unzip tree

      - name: Unzip Stikhi.zip (if present)
        run: |
          if [ -f Stikhi.zip ]; then
            rm -rf extracted
            unzip -o Stikhi.zip -d extracted
          fi
          echo "== ROOT =="
          ls -la
          echo "== EXTRACTED (top 2 levels) =="
          [ -d extracted ] && tree -L 2 extracted || true

      # Ищем корень по признакам settings.gradle(.kts) ИЛИ наличию app/build.gradle(.kts)
      - name: Detect project dir
        id: detect
        shell: bash
        run: |
          set -e
          find_candidate () {
            # settings.gradle(.kts)
            CAND=$(find "$1" -type f -regex ".*/settings\.gradle(\.kts)?$" -printf "%h\n" | head -n1 || true)
            if [ -n "$CAND" ]; then echo "$CAND"; return; fi
            # app/build.gradle(.kts)
            CAND=$(find "$1" -type f -regex ".*/app/build\.gradle(\.kts)?$" -printf "%h/..\n" | head -n1 | xargs -I{} realpath {} || true)
            if [ -n "$CAND" ]; then echo "$CAND"; return; fi
            echo ""
          }

          DIR=""
          # 1) Корень репо
          DIR=$(find_candidate ".")
          # 2) В распакованном архиве
          if [ -z "$DIR" ] && [ -d extracted ]; then
            DIR=$(find_candidate "extracted")
          fi
          # 3) Если внутри extracted только ОДНА папка — возьмём её
          if [ -z "$DIR" ] && [ -d extracted ]; then
            ONLY=$(find extracted -mindepth 1 -maxdepth 1 -type d | wc -l)
            if [ "$ONLY" = "1" ]; then
              DIR=$(find extracted -mindepth 1 -maxdepth 1 -type d | head -n1)
            fi
          fi

          if [ -z "$DIR" ]; then
            echo "Не удалось найти корень проекта. Пожалуйста, проверь содержимое ZIP." >&2
            exit 1
          fi

          echo "project_dir=$DIR" >> $GITHUB_OUTPUT
          echo "Using project_dir=$DIR"
          echo "== PROJECT DIR TREE (top 2 levels) =="
          tree -L 2 "$DIR" || true

      - name: Set up Java 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'

      - name: Set up Android SDK
        uses: android-actions/setup-android@v3

      - name: Install SDK packages
        run: |
          yes | sdkmanager --licenses
          sdkmanager "platform-tools" "platforms;android-34" "build-tools;34.0.0"

      # Если есть gradlew — используем его
      - name: Build with Gradle Wrapper (if present)
        if: hashFiles(format('{0}/gradlew', steps.detect.outputs.project_dir)) != ''
        working-directory: ${{ steps.detect.outputs.project_dir }}
        run: |
          chmod +x gradlew
          ./gradlew --no-daemon assembleDebug

      # Иначе — используем gradle action
      - name: Build with Gradle Action (fallback)
        if: hashFiles(format('{0}/gradlew', steps.detect.outputs.project_dir)) == ''
        uses: gradle/gradle-build-action@v3
        with:
          gradle-version: 8.9
          build-root-directory: ${{ steps.detect.outputs.project_dir }}
          arguments: assembleDebug

      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: Stikhi-debug-apk
          path: ${{ steps.detect.outputs.project_dir }}/app/build/outputs/apk/debug/app-debug.apk
