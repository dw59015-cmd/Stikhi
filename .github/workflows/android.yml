name: Android CI (ZIP build)

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Show repo root
        run: ls -la

      - name: Ensure unzip
        run: sudo apt-get update && sudo apt-get install -y unzip

      - name: Unzip project from ZIP
        id: unzip
        shell: bash
        run: |
          set -euo pipefail
          ZIP=$(ls -1 *.zip | head -n1 || true)
          if [ -z "$ZIP" ]; then
            echo "No *.zip found in repo root"; exit 1
          fi
          echo "Using ZIP: $ZIP"
          rm -rf proj && mkdir proj
          unzip -q "$ZIP" -d proj

          # найти корень проекта по наличию settings.gradle(.kts) или build.gradle(.kts)
          cd proj
          ROOT_CANDIDATE=$( \
            find . -maxdepth 2 \
              \( -name "settings.gradle" -o -name "settings.gradle.kts" -o -name "build.gradle" -o -name "build.gradle.kts" \) \
              | head -n1 | xargs -r dirname || true )
          if [ -z "$ROOT_CANDIDATE" ]; then
            echo "Gradle root not found inside ZIP"; exit 1
          fi

          echo "Detected root: $ROOT_CANDIDATE"
          # Если корень не '.', поднимем содержимое на уровень proj/
          if [ "$ROOT_CANDIDATE" != "." ]; then
            shopt -s dotglob
            mkdir -p __m && mv "$ROOT_CANDIDATE"/* __m/ && rm -rf ./* && mv __m/* . && rmdir __m || true
          fi
          cd ..

          echo "PROJECT_DIR=$GITHUB_WORKSPACE/proj" >> $GITHUB_ENV

      - name: Print project tree (top 3 levels)
        run: |
          cd "$PROJECT_DIR"
          find . -maxdepth 3 -type f | sed 's/^/  /'

      - name: Set up Java 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'

      - name: Detect Gradle wrapper
        id: gw
        shell: bash
        run: |
          cd "$PROJECT_DIR"
          if [ -x "./gradlew" ]; then
            echo "use_wrapper=true" >> $GITHUB_OUTPUT
          else
            echo "use_wrapper=false" >> $GITHUB_OUTPUT
          fi

      - name: Setup Gradle (no wrapper)
        if: steps.gw.outputs.use_wrapper == 'false'
        uses: gradle/actions/setup-gradle@v3

      - name: Make wrapper executable
        if: steps.gw.outputs.use_wrapper == 'true'
        run: chmod +x "$PROJECT_DIR/gradlew"

      - name: Build APK (release)
        working-directory: ${{ env.PROJECT_DIR }}
        run: |
          set -e
          if [ "${{ steps.gw.outputs.use_wrapper }}" = "true" ]; then
            ./gradlew :app:assembleRelease --no-daemon
          else
            gradle :app:assembleRelease --no-daemon
          fi

      - name: Upload APK artifact
        uses: actions/upload-artifact@v4
        with:
          name: Stikhi-release-apk
          path: ${{ env.PROJECT_DIR }}/app/build/outputs/apk/**/release/*.apk
          if-no-files-found: warn
