name: Android CI (inspectâ†’build)

on:
  push:
    branches: ["main"]
  workflow_dispatch:

jobs:
  inspect:
    runs-on: ubuntu-latest
    outputs:
      root: ${{ steps.detect.outputs.root }}
    steps:
      - uses: actions/checkout@v4

      - name: Pick ZIP by priority
        id: pick
        run: |
          set -e
          for Z in Stikhi_v1_3_androidx.zip Stikhi_v1_3_patched.zip Stikhi_v1_2.zip; do
            [ -f "$Z" ] && echo "zip=$Z" >> "$GITHUB_OUTPUT" && echo "Chosen $Z" && exit 0
          done
          echo "No ZIP"; ls -la; exit 1

      - name: Unzip
        run: |
          set -e
          rm -rf repo && mkdir repo
          unzip -o "${{ steps.pick.outputs.zip }}" -d repo
          echo "Top of repo/:"; find repo -maxdepth 2 -type f | sort

      - name: Detect Gradle root
        id: detect
        run: |
          set -e
          ROOT="$(dirname "$(find repo -maxdepth 2 -type f -name 'settings.gradle*' | head -n1)")"
          [ -z "$ROOT" ] && echo "settings.gradle* not found" && exit 1
          echo "root=$ROOT" >> "$GITHUB_OUTPUT"
          echo "Detected root: $ROOT"

      - name: Ensure gradle.properties, Material, icons
        run: |
          set -e
          ROOT='${{ steps.detect.outputs.root }}'
          GP="$ROOT/gradle.properties"
          if [ ! -f "$GP" ]; then
            printf '%s\n' \
              'android.useAndroidX=true' \
              'android.enableJetifier=true' \
              'org.gradle.jvmargs=-Xmx3g -Dkotlin.daemon.jvm.options=-Xmx1g' \
              'kotlin.code.style=official' \
              'org.gradle.warning.mode=all' > "$GP"
            echo "Created $GP"
          fi

          APPKTS="$ROOT/app/build.gradle.kts"; APPGR="$ROOT/app/build.gradle"
          if [ -f "$APPKTS" ]; then
            grep -q 'com.google.android.material:material' "$APPKTS" || awk '/dependencies *\{/{print;print "    implementation(\"com.google.android.material:material:1.12.0\")";next}1' "$APPKTS" > "$APPKTS.tmp" && mv "$APPKTS.tmp" "$APPKTS"
          elif [ -f "$APPGR" ]; then
            grep -q 'com.google.android.material:material' "$APPGR" || awk '/dependencies *\{/{print;print "    implementation '\''com.google.android.material:material:1.12.0'\''";next}1' "$APPGR" > "$APPGR.tmp" && mv "$APPGR.tmp" "$APPGR"
          else
            echo "app/build.gradle* not found"; exit 1
          fi

          RES="$ROOT/app/src/main/res"
          mkdir -p "$RES/mipmap-anydpi-v26" "$RES/drawable" "$RES/values"
          [ -f "$RES/mipmap-anydpi-v26/ic_launcher.xml" ] || printf '%s\n' '<?xml version="1.0" encoding="utf-8"?>' '<adaptive-icon xmlns:android="http://schemas.android.com/apk/res/android">' '  <background android:drawable="@color/ic_launcher_background"/>' '  <foreground android:drawable="@drawable/ic_launcher_foreground"/>' '</adaptive-icon>' > "$RES/mipmap-anydpi-v26/ic_launcher.xml"
          [ -f "$RES/mipmap-anydpi-v26/ic_launcher_round.xml" ] || cp "$RES/mipmap-anydpi-v26/ic_launcher.xml" "$RES/mipmap-anydpi-v26/ic_launcher_round.xml"
          [ -f "$RES/drawable/ic_launcher_foreground.xml" ] || printf '%s\n' '<?xml version="1.0" encoding="utf-8"?>' '<vector xmlns:android="http://schemas.android.com/apk/res/android" android:width="108dp" android:height="108dp" android:viewportWidth="108" android:viewportHeight="108">' '  <path android:fillColor="#FFFFFF" android:fillAlpha="0.9" android:pathData="M20,30h68a8,8 0 0 1 8,8v40a8,8 0 0 1 -8,8H20a8,8 0 0 1 -8,-8V38a8,8 0 0 1 8,-8z"/>' '  <path android:fillColor="#3F51B5" android:pathData="M28,38h52a4,4 0 0 1 4,4v24a12,12 0 0 1 -12,12H28z"/>' '  <path android:fillColor="#FFFFFF" android:pathData="M36,48h36v4H36zM36,56h28v4H36zM36,64h22v4H36z"/>' '  <path android:fillColor="#FF4081" android:pathData="M70,28c6,8 10,14 10,18 0,6 -6,10 -10,10 -4,0 -10,-4 -10,-10 0,-4 4,-10 10,-18z"/>' '</vector>' > "$RES/drawable/ic_launcher_foreground.xml"
          [ -f "$RES/values/ic_launcher_background.xml" ] || printf '%s\n' '<?xml version="1.0" encoding="utf-8"?>' '<resources>' '  <color name="ic_launcher_background">#121212</color>' '</resources>' > "$RES/values/ic_launcher_background.xml"

          echo "Inspection OK."

  build:
    needs: inspect
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Re-unzip selected ZIP
        run: |
          set -e
          for Z in Stikhi_v1_3_androidx.zip Stikhi_v1_3_patched.zip Stikhi_v1_2.zip; do
            [ -f "$Z" ] && echo "Using $Z" && rm -rf repo && mkdir repo && unzip -o "$Z" -d repo && break
          done

      - name: Set up Java 17 & Android SDK
        uses: actions/setup-java@v4
        with: { distribution: temurin, java-version: "17" }
      - uses: android-actions/setup-android@v3
      - run: yes | sdkmanager --licenses

      - name: Detect root
        id: detect
        run: |
          ROOT="$(dirname "$(find repo -maxdepth 2 -type f -name 'settings.gradle*' | head -n1)")"
          [ -z "$ROOT" ] && echo "settings.gradle* not found" && exit 1
          echo "root=$ROOT" >> "$GITHUB_OUTPUT"
          echo "Root: $ROOT"

      - name: Ensure props/material/icons again (idempotent)
        run: |
          set -e
          ROOT='${{ steps.detect.outputs.root }}'
          GP="$ROOT/gradle.properties"
          grep -q 'android.useAndroidX=true' "$GP" 2>/dev/null || echo 'android.useAndroidX=true' >> "$GP"
          grep -q 'android.enableJetifier=true' "$GP" 2>/dev/null || echo 'android.enableJetifier=true' >> "$GP"

          APPKTS="$ROOT/app/build.gradle.kts"; APPGR="$ROOT/app/build.gradle"
          if [ -f "$APPKTS" ]; then
            grep -q 'com.google.android.material:material' "$APPKTS" || awk '/dependencies *\{/{print;print "    implementation(\"com.google.android.material:material:1.12.0\")";next}1' "$APPKTS" > "$APPKTS.tmp" && mv "$APPKTS.tmp" "$APPKTS"
          elif [ -f "$APPGR" ]; then
            grep -q 'com.google.android.material:material' "$APPGR" || awk '/dependencies *\{/{print;print "    implementation '\''com.google.android.material:material:1.12.0'\''";next}1' "$APPGR" > "$APPGR.tmp" && mv "$APPGR.tmp" "$APPGR"
          fi

          RES="$ROOT/app/src/main/res"
          mkdir -p "$RES/mipmap-anydpi-v26" "$RES/drawable" "$RES/values"
          [ -f "$RES/mipmap-anydpi-v26/ic_launcher.xml" ] || printf '%s\n' '<?xml version="1.0" encoding="utf-8"?>' '<adaptive-icon xmlns:android="http://schemas.android.com/apk/res/android">' '  <background android:drawable="@color/ic_launcher_background"/>' '  <foreground android:drawable="@drawable/ic_launcher_foreground"/>' '</adaptive-icon>' > "$RES/mipmap-anydpi-v26/ic_launcher.xml"
          [ -f "$RES/mipmap-anydpi-v26/ic_launcher_round.xml" ] || cp "$RES/mipmap-anydpi-v26/ic_launcher.xml" "$RES/mipmap-anydpi-v26/ic_launcher_round.xml"
          [ -f "$RES/drawable/ic_launcher_foreground.xml" ] || printf '%s\n' '<?xml version="1.0" encoding="utf-8"?>' '<vector xmlns:android="http://schemas.android.com/apk/res/android" android:width="108dp" android:height="108dp" android:viewportWidth="108" android:viewportHeight="108">' '  <path android:fillColor="#FFFFFF" android:fillAlpha="0.9" android:pathData="M20,30h68a8,8 0 0 1 8,8v40a8,8 0 0 1 -8,8H20a8,8 0 0 1 -8,-8V38a8,8 0 0 1 8,-8z"/>' '  <path android:fillColor="#3F51B5" android:pathData="M28,38h52a4,4 0 0 1 4,4v24a12,12 0 0 1 -12,12H28z"/>' '  <path android:fillColor="#FFFFFF" android:pathData="M36,48h36v4H36zM36,56h28v4H36zM36,64h22v4H36z"/>' '  <path android:fillColor="#FF4081" android:pathData="M70,28c6,8 10,14 10,18 0,6 -6,10 -10,10 -4,0 -10,-4 -10,-10 0,-4 4,-10 10,-18z"/>' '</vector>' > "$RES/drawable/ic_launcher_foreground.xml"
          [ -f "$RES/values/ic_launcher_background.xml" ] || printf '%s\n' '<?xml version="1.0" encoding="utf-8"?>' '<resources>' '  <color name="ic_launcher_background">#121212</color>' '</resources>' > "$RES/values/ic_launcher_background.xml"

      - name: Build release APK
        working-directory: ${{ steps.detect.outputs.root }}
        run: |
          set -e
          if [ -f "./gradlew" ]; then chmod +x ./gradlew && ./gradlew :app:assembleRelease --no-daemon; else gradle :app:assembleRelease --no-daemon; fi

      - uses: actions/upload-artifact@v4
        with:
          name: Stikhi-release-apk
          path: ${{ steps.detect.outputs.root }}/app/build/outputs/apk/release/*.apk
