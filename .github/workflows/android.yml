name: Android CI

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Java 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'

      - name: Set up Android SDK
        uses: android-actions/setup-android@v3

      - name: Accept Android SDK licenses
        run: yes | sdkmanager --licenses

      # --- Pick project archive by priority ---
      - name: Select project ZIP
        id: pick
        run: |
          set -e
          if [ -f "Stikhi_v1_3_androidx.zip" ]; then
            echo "zip=Stikhi_v1_3_androidx.zip" >> "$GITHUB_OUTPUT"
          elif [ -f "Stikhi_v1_3_patched.zip" ]; then
            echo "zip=Stikhi_v1_3_patched.zip" >> "$GITHUB_OUTPUT"
          elif [ -f "Stikhi_v1_2.zip" ]; then
            echo "zip=Stikhi_v1_2.zip" >> "$GITHUB_OUTPUT"
          else
            echo "ZIP archive not found in repo root"; ls -la; exit 1
          fi
          echo "Chosen ZIP: $(sed -n 's/^zip=//p' $GITHUB_OUTPUT)"

      - name: Unzip selected ZIP
        run: |
          set -e
          rm -rf repo
          mkdir repo
          unzip -o "${{ steps.pick.outputs.zip }}" -d repo
          echo "Contents of repo/:"
          find repo -maxdepth 2 -type f | sort

      - name: Detect Gradle project root
        id: detect
        run: |
          set -e
          ROOT=$(dirname "$(find repo -maxdepth 2 -type f -name 'settings.gradle*' | head -n1)")
          if [ -z "$ROOT" ]; then
            echo "settings.gradle(.kts) not found"; exit 1
          fi
          echo "root=$ROOT" >> "$GITHUB_OUTPUT"
          echo "Detected root: $ROOT"
          find "$ROOT" -maxdepth 2 -type f | sort

      # --- Ensure AndroidX flags and sane JVM options ---
      - name: Ensure gradle.properties (AndroidX, JVM)
        run: |
          set -e
          ROOT="${{ steps.detect.outputs.root }}"
          GP="$ROOT/gradle.properties"
          if [ ! -f "$GP" ]; then
            {
              echo "android.useAndroidX=true"
              echo "android.enableJetifier=true"
              echo "org.gradle.jvmargs=-Xmx3g -Dkotlin.daemon.jvm.options=-Xmx1g"
              echo "kotlin.code.style=official"
              echo "org.gradle.warning.mode=all"
            } > "$GP"
            echo "Created gradle.properties"
          else
            echo "Existing gradle.properties:"
            cat "$GP"
          fi

      # --- Patch Compose plugin for Kotlin 2.x if missing ---
      - name: Patch Compose plugin if missing
        run: |
          set -e
          ROOT="${{ steps.detect.outputs.root }}"
          # root build file
          if [ -f "$ROOT/build.gradle.kts" ]; then
            if ! grep -q 'org.jetbrains.kotlin.plugin.compose' "$ROOT/build.gradle.kts"; then
              sed -i '0,/plugins *{/{s//plugins {\n    id("org.jetbrains.kotlin.plugin.compose") version "2.0.21" apply false/}' "$ROOT/build.gradle.kts"
              echo "Patched root build.gradle.kts with Compose plugin"
            fi
          elif [ -f "$ROOT/build.gradle" ]; then
            if ! grep -q 'org.jetbrains.kotlin.plugin.compose' "$ROOT/build.gradle"; then
              sed -i "0,/plugins *{/{s//plugins {\\n    id 'org.jetbrains.kotlin.plugin.compose' version '2.0.21' apply false/}" "$ROOT/build.gradle"
              echo "Patched root build.gradle with Compose plugin"
            fi
          fi
          # app module build file
          if [ -f "$ROOT/app/build.gradle.kts" ]; then
            if ! grep -q 'org.jetbrains.kotlin.plugin.compose' "$ROOT/app/build.gradle.kts"; then
              sed -i '0,/plugins *{/{s//plugins {\n    id("org.jetbrains.kotlin.plugin.compose")/}' "$ROOT/app/build.gradle.kts"
              echo "Patched app/build.gradle.kts with Compose plugin"
            fi
            # remove legacy composeOptions block (Kotlin 2.x manages it)
            perl -0777 -pe 's/composeOptions\s*\{[^}]*\}//s' -i "$ROOT/app/build.gradle.kts" || true
          elif [ -f "$ROOT/app/build.gradle" ]; then
            if ! grep -q 'org.jetbrains.kotlin.plugin.compose' "$ROOT/app/build.gradle"; then
              sed -i "0,/plugins *{/{s//plugins {\\n    id 'org.jetbrains.kotlin.plugin.compose'/}" "$ROOT/app/build.gradle"
              echo "Patched app/build.gradle with Compose plugin"
            fi
          fi

      # --- Ensure Material Components dependency for Theme.Material3.* in XML ---
      - name: Ensure Material Components dependency (Theme.Material3)
        run: |
          set -e
          ROOT="${{ steps.detect.outputs.root }}"
          APP_KTS="$ROOT/app/build.gradle.kts"
          APP_GROOVY="$ROOT/app/build.gradle"

          insert_dep_kts() {
            local f="$1"
            if ! grep -q 'com.google.android.material:material' "$f"; then
              sed -i '0,/dependencies\s*{/{s//dependencies {\n    implementation("com.google.android.material:material:1.12.0")/}' "$f"
              echo "Added Material Components to $f"
            else
              echo "Material Components already present in $f"
            fi
          }

          insert_dep_groovy() {
            local f="$1"
            if ! grep -q 'com.google.android.material:material' "$f"; then
              sed -i "0,/dependencies\s*{/{s//dependencies {\\n    implementation 'com.google.android.material:material:1.12.0'/}" "$f"
              echo "Added Material Components to $f"
            else
              echo "Material Components already present in $f"
            fi
          }

          if [ -f "$APP_KTS" ]; then
            insert_dep_kts "$APP_KTS"
            head -n 160 "$APP_KTS" || true
          elif [ -f "$APP_GROOVY" ]; then
            insert_dep_groovy "$APP_GROOVY"
            head -n 160 "$APP_GROOVY" || true
          else
            echo "app build.gradle* not found"; exit 1
          fi

      - name: Build APK (release)
        working-directory: ${{ steps.detect.outputs.root }}
        run: |
          set -e
          if [ -f "./gradlew" ]; then
            chmod +x ./gradlew
            ./gradlew :app:assembleRelease --no-daemon
          else
            gradle :app:assembleRelease --no-daemon
          fi

      - name: Upload APK artifact
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: Stikhi-release-apk
          path: ${{ steps.detect.outputs.root }}/app/build/outputs/apk/release/*.apk
