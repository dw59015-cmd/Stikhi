name: Android CI

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Java 17
        uses: actions/setup-java@v4
        with:
          distribution: "temurin"
          java-version: "17"

      - name: Set up Android SDK
        uses: android-actions/setup-android@v3

      - name: Accept Android SDK licenses
        run: yes | sdkmanager --licenses

      - name: Unzip latest ZIP
        run: |
          set -e
          rm -rf repo
          mkdir repo
          ZIP=$(ls -t *.zip | head -n1)
          echo "Using ZIP: $ZIP"
          unzip -o "$ZIP" -d repo
          ls -la repo

      - name: Detect Gradle project root
        id: detect
        run: |
          set -e
          ROOT=$(dirname "$(find repo -maxdepth 2 -type f -name 'settings.gradle*' | head -n1)")
          if [ -z "$ROOT" ]; then
            echo "âŒ settings.gradle(.kts) not found"
            exit 1
          fi
          echo "root=$ROOT" >> "$GITHUB_OUTPUT"
          echo "Detected root: $ROOT"
          find "$ROOT" -maxdepth 2 -type f -printf '%P\n' | sort

      - name: Ensure gradle.properties has AndroidX flags
        run: |
          set -e
          ROOT='${{ steps.detect.outputs.root }}'
          GP="$ROOT/gradle.properties"
          if [ ! -f "$GP" ]; then
            echo "Creating $GP"
            cat > "$GP" << 'EOF'
android.useAndroidX=true
android.enableJetifier=true
org.gradle.jvmargs=-Xmx3g -Dkotlin.daemon.jvm.options=-Xmx1g
kotlin.code.style=official
org.gradle.warning.mode=all
EOF
          else
            echo "gradle.properties exists:"
            cat "$GP"
          fi

      - name: Build APK (release)
        working-directory: ${{ steps.detect.outputs.root }}
        run: |
          set -e
          if [ -f "./gradlew" ]; then
            chmod +x ./gradlew
            ./gradlew :app:assembleRelease --no-daemon
          else
            gradle :app:assembleRelease --no-daemon
          fi

      - name: Upload APK artifact
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: Stikhi-release-apk
          path: ${{ steps.detect.outputs.root }}/app/build/outputs/apk/release/*.apk
