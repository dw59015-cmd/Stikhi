name: Android CI (auto-detect & build from ZIP)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install tools
        run: |
          sudo apt-get update -y
          sudo apt-get install -y unzip tree

      - name: Unzip Stikhi.zip (if present) & show tree
        run: |
          if [ -f Stikhi.zip ]; then
            rm -rf extracted
            unzip -o Stikhi.zip -d extracted
          fi
          echo "== ROOT =="
          ls -la
          echo "== EXTRACTED (top 2 levels) =="
          [ -d extracted ] && tree -L 2 extracted || true

      - name: Find Android project candidates
        id: find
        shell: bash
        run: |
          set -e
          CAND=""
          # ищем корни по settings.gradle(.kts)
          C1=$(find . -type f -regex ".*/settings\.gradle(\.kts)?$" -printf "%h\n" | sort -u || true)
          # ищем корни по app/build.gradle(.kts)
          C2=$(find . -type f -regex ".*/app/build\.gradle(\.kts)?$" -printf "%h/..\n" | xargs -I{} realpath {} 2>/dev/null | sort -u || true)
          CAND=$(printf "%s\n%s\n" "$C1" "$C2" | sed '/^$/d' | sort -u)
          echo "Найдены кандидаты:"
          echo "$CAND"
          if [ -z "$CAND" ]; then
            echo "Не нашёл корень проекта. Посмотри дерево выше (Unzip step)."; exit 1
          fi
          # сохраним в файл
          printf "%s\n" "$CAND" > candidates.txt
          echo "candidates=$(printf "%s" "$CAND" | tr '\n' ' ')" >> $GITHUB_OUTPUT

      - name: Set up Java 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'

      - name: Set up Android SDK
        uses: android-actions/setup-android@v3

      - name: Install SDK packages
        run: |
          yes | sdkmanager --licenses
          sdkmanager "platform-tools" "platforms;android-34" "build-tools;34.0.0"

      - name: Try build each candidate
        shell: bash
        run: |
          set -e
          ok=0
          while IFS= read -r dir; do
            [ -z "$dir" ] && continue
            echo "==== Пытаюсь собрать: $dir ===="
            if [ -f "$dir/gradlew" ]; then
              (cd "$dir" && chmod +x gradlew && ./gradlew --no-daemon assembleDebug) && ok=1 || echo "Не удалось собрать $dir (gradlew)"
            else
              # fallback через gradle action: локально вызовем gradle, если wrapper отсутствует
              (cd "$dir" && gradle -v >/dev/null 2>&1 || true)
              (cd "$dir" && ./gradlew --version >/dev/null 2>&1 || true)
              echo "Wrapper не найден в $dir — пробую через gradle-wrapper подниматься из проекта"
              (cd "$dir" && ./gradlew --no-daemon assembleDebug) && ok=1 || echo "Не удалось собрать $dir (fallback)"
            fi
          done < candidates.txt
          if [ $ok -eq 0 ]; then
            echo "Не удалось собрать ни одного кандидата."; exit 1
          fi

      - name: Upload found APKs
        uses: actions/upload-artifact@v4
        with:
          name: Stikhi-apks
          path: |
            **/app/build/outputs/apk/**/app-*.apk
            **/app/build/outputs/apk/**/app-*.aab
          if-no-files-found: warn
